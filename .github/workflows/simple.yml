name: 编译 Simple 原生库

on:
  push:
    branches:
      - simple-native
    tags:
      - Nv[0-9]+.[0-9]+.[0-9]+
  workflow_dispatch:

permissions:
  contents: write

env:
  TAG_NAME: simple-native ${{ github.ref_name }}

jobs:


  Windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: '安装 CMake'
        uses: lukka/get-cmake@v3.31.6

      - name: '获取 simple/vcpkg 的 commit id'
        id: vcpkg_commit
        run: |
          cd "${{ github.workspace }}/simple"
          COMMIT_ID=$(git ls-tree HEAD vcpkg | awk '{print $3}')
          echo "commit_id=$COMMIT_ID" >> $GITHUB_OUTPUT
          echo "vcpkg commit id: $COMMIT_ID"
        shell: bash

      - name: '安装并配置 vcpkg'
        uses: lukka/run-vcpkg@v10
        with:
          vcpkgDirectory: ${{ github.workspace }}/simple/vcpkg
          vcpkgGitCommitId: ${{ steps.vcpkg_commit.outputs.commit_id }}
      - run: |
          echo "RUNVCPKG_NO_CACHE=1" >> $GITHUB_ENV
        if: ${{ failure() || cancelled() }}
        shell: bash

      - name: '复制 CMakePresets.json'
        run: |
          Copy-Item "${{ github.workspace }}/simple/CMakePresets.json" "${{ github.workspace }}/CMakePresets.json"
          $content = Get-Content "${{ github.workspace }}/CMakePresets.json" -Raw
          $content = $content -replace '\$\{sourceDir\}/vcpkg/scripts/buildsystems/vcpkg\.cmake', '${sourceDir}/simple/vcpkg/scripts/buildsystems/vcpkg.cmake'
          Set-Content "${{ github.workspace }}/CMakePresets.json" -Value $content -NoNewline
        shell: pwsh

      - name: '通过 CMake 编译'
        uses: lukka/run-cmake@v10
        continue-on-error: false
        with:
          configurePreset: 'windows-msvc-vs17'
          buildPreset: 'windows-msvc-vs17-release'

      - name: '重命名编译产物'
        run: |
          Copy-Item "${{ github.workspace }}/../../_temp/windows/simple/src/release/simple.dll" simple-windows-x64.dll
        shell: pwsh

      - name: '上传编译产物'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          draft: true
          files: simple-windows-x64.dll


  MacOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: '[MacOS] 安装 CMake'
        uses: lukka/get-cmake@v3.31.6

      - name: '[MacOS] 获取 simple/vcpkg 的 commit id'
        id: vcpkg_commit
        run: |
          cd "${{ github.workspace }}/simple"
          COMMIT_ID=$(git ls-tree HEAD vcpkg | awk '{print $3}')
          echo "commit_id=$COMMIT_ID" >> $GITHUB_OUTPUT
          echo "vcpkg commit id: $COMMIT_ID"
        shell: bash

      - name: '[MacOS] 安装并配置 vcpkg'
        uses: lukka/run-vcpkg@v10
        with:
          vcpkgDirectory: ${{ github.workspace }}/simple/vcpkg
          vcpkgGitCommitId: ${{ steps.vcpkg_commit.outputs.commit_id }}
      - run: |
          echo "RUNVCPKG_NO_CACHE=1" >> $GITHUB_ENV
        if: ${{ failure() || cancelled() }}
        shell: bash

      - name: '[MacOS] 复制 CMakePresets.json'
        run: |
          cp "${{ github.workspace }}/simple/CMakePresets.json" "${{ github.workspace }}/CMakePresets.json"
          sed -i '' 's|${sourceDir}/vcpkg/scripts/buildsystems/vcpkg.cmake|${sourceDir}/simple/vcpkg/scripts/buildsystems/vcpkg.cmake|g' "${{ github.workspace }}/CMakePresets.json"
        shell: bash

      - name: '[MacOS] 通过 CMake 编译'
        uses: lukka/run-cmake@v10
        continue-on-error: false
        with:
          configurePreset: 'macos-ninja'
          buildPreset: 'macos-ninja-release'

      - name: '[MacOS] 重命名编译产物'
        run: cp "${{ github.workspace }}/../../_temp/macos/simple/src/libsimple.dylib" libsimple-macos-universal.dylib
        shell: bash

      - name: '[iOS] 执行脚本，通过 CMake 编译'
        run: |
          ./build-ios.sh
          cp "${{ github.workspace }}/out/bin/libsimple.a" libsimple-ios-arm64.a
        env:
          IOS_SIMULATOR: false

      - name: '[iOS Simulator] 执行脚本，通过 CMake 编译'
        run: |
          ./build-ios.sh
          cp "${{ github.workspace }}/out-simulator/bin/libsimple.a" libsimple-ios-simulator-universal.a
        env:
          IOS_SIMULATOR: true

      - name: '上传编译产物'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          draft: true
          files: |
            libsimple-macos-universal.dylib
            libsimple-ios-arm64.a
            libsimple-ios-simulator-universal.a


  Android:
    runs-on: ubuntu-latest
    environment: simple-native-android

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: '设置 Android 环境'
        uses: android-actions/setup-android@v3

      - name: '通过 Gradle 编译'
        run: |
          chmod +x ./gradlew
          ./gradlew publishToMavenCentral --info
        working-directory: ${{ github.workspace }}/src/android
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralUsername }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyId }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKey }}
          SNAPSHOT: ${{ !startsWith(github.ref, 'refs/tags/Nv') }}

      - name: '解压 aar 并提取 so 库'
        run: |
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"
          unzip -q "${{ github.workspace }}/src/android/simple-native-android/build/outputs/aar/simple-native-android-release.aar"
          for abi_dir in jni/*/; do
            abi=$(basename "$abi_dir")
            cp "$abi_dir/libsimple.so" "${{ github.workspace }}/libsimple-android-$abi.so"
          done
          rm -rf "$EXTRACT_DIR"
        shell: bash

      - name: '上传编译产物'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          draft: true
          files: |
            libsimple-android-*.so