name: 编译 Simple 原生库

on:
  push:
#    branches:
#      - simple-native
    tags:
      - Nv[0-9]+.[0-9]+.[0-9]+
  workflow_dispatch:

permissions:
  contents: write

env:
  TAG_NAME: simple-native ${{ github.ref_name }}

jobs:
  Windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - run: cp zdic.txt simple/contrib/pinyin.txt
        shell: bash

      - name: '安装 CMake'
        uses: lukka/get-cmake@v3.31.6

      - name: '获取 simple/vcpkg 的 commit id'
        id: vcpkg_commit
        run: |
          cd simple
          COMMIT_ID=$(git ls-tree HEAD vcpkg | awk '{print $3}')
          echo "commit_id=$COMMIT_ID" >> $GITHUB_OUTPUT
          echo "vcpkg commit id: $COMMIT_ID"
        shell: bash

      - name: '安装并配置 vcpkg'
        uses: lukka/run-vcpkg@v10
        with:
          vcpkgDirectory: simple/vcpkg
          vcpkgGitCommitId: ${{ steps.vcpkg_commit.outputs.commit_id }}
      - run: |
          echo "RUNVCPKG_NO_CACHE=1" >> $GITHUB_ENV
        if: ${{ failure() || cancelled() }}
        shell: bash

      - name: '复制 CMakePresets.json'
        run: |
          Copy-Item "simple/CMakePresets.json" "CMakePresets.json"
          $content = Get-Content "CMakePresets.json" -Raw
          $content = $content -replace '\$\{sourceDir\}/vcpkg/scripts/buildsystems/vcpkg\.cmake', '${sourceDir}/simple/vcpkg/scripts/buildsystems/vcpkg.cmake'
          Set-Content "CMakePresets.json" -Value $content -NoNewline
        shell: pwsh

      - name: '通过 CMake 编译'
        uses: lukka/run-cmake@v10
        continue-on-error: false
        with:
          configurePreset: 'windows-msvc-vs17'
          buildPreset: 'windows-msvc-vs17-release'

      - name: '重命名编译产物'
        run: |
          Copy-Item "../../_temp/windows/simple/src/release/simple.dll" simple.dll
        shell: pwsh

      - name: '上传 Windows 产物'
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: simple.dll

  MacOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - run: cp zdic.txt simple/contrib/pinyin.txt
        shell: bash

      - name: '[MacOS] 安装 CMake'
        uses: lukka/get-cmake@v3.31.6

      - name: '[MacOS] 获取 simple/vcpkg 的 commit id'
        id: vcpkg_commit
        run: |
          cd simple
          COMMIT_ID=$(git ls-tree HEAD vcpkg | awk '{print $3}')
          echo "commit_id=$COMMIT_ID" >> $GITHUB_OUTPUT
          echo "vcpkg commit id: $COMMIT_ID"
        shell: bash

      - name: '[MacOS] 安装并配置 vcpkg'
        uses: lukka/run-vcpkg@v10
        with:
          vcpkgDirectory: simple/vcpkg
          vcpkgGitCommitId: ${{ steps.vcpkg_commit.outputs.commit_id }}
      - run: |
          echo "RUNVCPKG_NO_CACHE=1" >> $GITHUB_ENV
        if: ${{ failure() || cancelled() }}
        shell: bash

      - name: '[MacOS] 复制 CMakePresets.json'
        run: |
          cp "simple/CMakePresets.json" "CMakePresets.json"
          sed -i '' 's|${sourceDir}/vcpkg/scripts/buildsystems/vcpkg.cmake|${sourceDir}/simple/vcpkg/scripts/buildsystems/vcpkg.cmake|g' "CMakePresets.json"
        shell: bash

      - name: '[MacOS] 通过 CMake 编译'
        uses: lukka/run-cmake@v10
        continue-on-error: false
        with:
          configurePreset: 'macos-ninja'
          buildPreset: 'macos-ninja-release'

      - name: '[MacOS] 重命名编译产物'
        run: cp ../../_temp/macos/simple/src/libsimple.dylib libsimple.dylib

      - name: '[iOS] 执行脚本，通过 CMake 编译'
        run: |
          ./build-ios.sh
          cp out/bin/libsimple.a libsimple.a
        env:
          IOS_SIMULATOR: false

      - name: '[iOS Simulator] 执行脚本，通过 CMake 编译'
        run: |
          ./build-ios.sh
          cp out-simulator/bin/libsimple.a libsimple-simulator.a
        env:
          IOS_SIMULATOR: true

      - name: '上传 MacOS/iOS 产物'
        uses: actions/upload-artifact@v4
        with:
          name: macos-ios
          path: |
            libsimple.dylib
            libsimple.a
            libsimple-simulator.a


  Android:
    runs-on: ubuntu-latest
    environment: simple-native-android

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - run: cp zdic.txt simple/contrib/pinyin.txt
        shell: bash

      - name: '设置 Android 环境'
        uses: android-actions/setup-android@v3

      - name: '通过 Gradle 编译'
        run: |
          chmod +x ./gradlew
          ./gradlew publishToMavenCentral --info
        working-directory: src/android
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralUsername }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyId }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKey }}
          SNAPSHOT: ${{ !startsWith(github.ref, 'refs/tags/Nv') }}

      - name: '解压 aar 并提取 so 库'
        run: |
          unzip -q src/android/simple-native-android/build/outputs/aar/simple-native-android-release.aar -d temp_aar
        shell: bash

      - name: '上传 Android 产物'
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: temp_aar/jni/


  Package:
    runs-on: ubuntu-latest
    needs: [Windows, MacOS, Android]
    steps:
      - name: '下载所有产物'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: '整理并打包'
        run: |
          mkdir -p dist/{windows,macos,ios,android} 
          
          cp artifacts/windows/simple.dll dist/windows/simple.dll
          cp artifacts/macos-ios/libsimple.dylib dist/macos/libsimple.dylib
          cp artifacts/macos-ios/libsimple.a dist/ios/libsimple.a
          cp artifacts/macos-ios/libsimple-simulator.a dist/ios/libsimple-simulator.a
          
          cp -r artifacts/android/* dist/android/
          
          cd dist && zip -r ../libsimple.zip .
        shell: bash

      - name: '上传最终产物到 Release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          draft: true
          files: libsimple.zip
